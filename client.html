<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Chat Parcial III - 100% FUNCIONAL</title><style>
  body{font-family:Arial;background:#111;color:#fff;margin:0;padding:20px;}
  .card{background:#222;padding:20px;border-radius:12px;margin:20px auto;max-width:800px;}
  input,button{width:100%;padding:12px;margin:8px 0;border:none;border-radius:8px;}
  input{background:#333;color:white;}
  button{background:#00bfff;color:white;font-weight:bold;cursor:pointer;}
  .room{background:#333;padding:15px;margin:10px 0;border-radius:10px;cursor:pointer;}
  .room:hover{background:#444;}
  #messages{height:500px;overflow-y:auto;background:#000;padding:15px;border-radius:10px;margin:10px 0;}
  .msg{margin:8px 0;padding:10px;background:#333;border-radius:8px;}
  .system{color:#0f0;font-style:italic;}
</style></head><body>

<div id="login" class="card">
  <h1>ChatApp - Parcial III</h1>
  <input id="username" placeholder="Usuario">
  <input id="password" type="password" placeholder="Contraseña">
  <button onclick="login()">Iniciar Sesión</button>
  <button onclick="register()">Registrarse</button>
</div>

<div id="app" class="card" style="display:none">
  <h2>Bienvenido, <span id="currentUser"></span> <button onclick="logout()">Salir</button></h2>
  <button onclick="createRoom()">Crear Sala Nueva</button>
  <h3>Salas disponibles:</h3>
  <div id="roomList"></div>

  <div id="chat" style="display:none;margin-top:20px;">
    <h3>Chat en sala: <span id="currentRoom"></span> <button onclick="leaveRoom()">Salir</button></h3>
    <div id="messages"></div>
    <input id="messageInput" placeholder="Escribe un mensaje..." onkeypress="if(event.key==='Enter')sendMessage()">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
const API = "http://localhost:3000";
let token = null, currentUser = null, ws = null, currentRoomId = null;

async function login() {
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value;
  await auth("/auth/login", u, p);
}

async function register() {
  const u = prompt("Nuevo usuario:");
  const p = prompt("Contraseña:");
  if (u && p) await auth("/auth/register", u, p);
}

async function auth(endpoint, username, password) {
  const res = await fetch(API + endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });
  const data = await res.json();
  if (data.token) {
    token = data.token;
    currentUser = data.user.username;
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "block";
    document.getElementById("currentUser").textContent = currentUser;
    loadRooms();
  } else {
    alert(data.error || "Error de autenticación");
  }
}

function logout() {
  token = currentUser = null;
  if (ws) ws.close();
  document.getElementById("app").style.display = "none";
  document.getElementById("login").style.display = "block";
}

async function loadRooms() {
  const res = await fetch(API + "/rooms");
  const rooms = await res.json();
  const list = document.getElementById("roomList");
  list.innerHTML = "";
  rooms.forEach(r => {
    const div = document.createElement("div");
    div.className = "room";
    div.innerHTML = `<strong>${r.name}</strong> ${r.is_private ? "(Privada)" : ""}`;
    div.onclick = () => joinRoom(r.id, r.is_private);
    list.appendChild(div);
  });
}

function createRoom() {
  const name = prompt("Nombre de la sala:");
  if (!name) return;
  const isPrivate = confirm("¿Sala privada?");
  const password = isPrivate ? prompt("Código de acceso:") : "";
  
  fetch(API + "/rooms", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, isPrivate, password })
  }).then(() => loadRooms());
}

function joinRoom(roomId, isPrivate) {
  const code = isPrivate ? prompt("Código de la sala:") : "";
  if (ws) ws.close();

  ws = new WebSocket(`ws://localhost:4000?token=${token}`);

  ws.onopen = () => {
    ws.send(JSON.stringify({ type: "join", roomId: Number(roomId), accessCode: code }));
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    const messagesDiv = document.getElementById("messages");

    if (msg.type === "joined") {
      currentRoomId = roomId;
      document.getElementById("currentRoom").textContent = msg.name || roomId;
      document.getElementById("chat").style.display = "block";
      messagesDiv.innerHTML = "<div class='system'>Te has unido a la sala</div>";
    }
    if (msg.type === "message") {
      messagesDiv.innerHTML += `<div class='msg'><strong>${msg.username}:</strong> ${msg.content}</div>`;
    }
    if (msg.type === "notification") {
      messagesDiv.innerHTML += `<div class='system'>${msg.message}</div>`;
    }
    if (msg.type === "error") {
      alert("Error: " + msg.message);
    }
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  };
}

function sendMessage() {
  const input = document.getElementById("messageInput");
  if (input.value.trim() && ws && currentRoomId) {
    ws.send(JSON.stringify({
      type: "message",
      roomId: Number(currentRoomId),
      content: input.value.trim()
    }));
    input.value = "";
  }
}

function leaveRoom() {
  if (ws) ws.close();
  document.getElementById("chat").style.display = "none";
  currentRoomId = null;
}
</script>
</body></html>